name: Daily Snapshot Scheduler

on:
  schedule:
    # Run daily at 04:00 Berlin time (02:00 UTC in summer, 03:00 UTC in winter)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-snapshots:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Active Schedules
        id: fetch
        run: |
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_KEY }}"
          API_KEY="${{ secrets.VITE_SUPABASE_KEY }}"
          
          echo "Fetching schedules from: $SUPABASE_URL"
          
          # Fetch ONLY scheduled_snapshots table, no joins
          SCHEDULES=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/scheduled_snapshots?status=eq.active&select=id,player_id,scheduled_until" \
            -H "apikey: ${API_KEY}")
          
          echo "API Response:"
          echo "$SCHEDULES"
          
          # Store in output
          echo "schedules=$SCHEDULES" >> $GITHUB_OUTPUT

      - name: Process Snapshots
        run: |
          API_KEY="${{ secrets.VITE_SUPABASE_KEY }}"
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          SCHEDULES='${{ steps.fetch.outputs.schedules }}'
          
          echo "Input schedules: $SCHEDULES"
          
          # Check if empty
          COUNT=$(echo "$SCHEDULES" | jq 'length')
          echo "Found $COUNT schedules"
          
          if [ "$COUNT" -eq 0 ]; then
            echo "No active schedules found"
            exit 0
          fi
          
          # Loop through each schedule
          echo "$SCHEDULES" | jq -c '.[]' | while IFS= read -r schedule; do
            PLAYER_ID=$(echo "$schedule" | jq -r '.player_id')
            SCHEDULED_UNTIL=$(echo "$schedule" | jq -r '.scheduled_until')
            
            echo "Processing schedule: player_id=$PLAYER_ID, scheduled_until=$SCHEDULED_UNTIL"
            
            # Check if scheduled_until is in the future
            NOW=$(date -u +%s)
            UNTIL_SECONDS=$(date -d "$SCHEDULED_UNTIL" +%s 2>/dev/null || echo 0)
            
            if [ "$UNTIL_SECONDS" -le "$NOW" ]; then
              echo "‚è∞ Schedule expired, skipping"
              continue
            fi
            
            # NOW fetch the player data for this player_id
            PLAYER=$(curl -s -X GET \
              "${SUPABASE_URL}/rest/v1/players?player_id=eq.${PLAYER_ID}&select=puuid,gameName,tagline" \
              -H "apikey: ${API_KEY}" | jq '.[0]')
            
            echo "Player data: $PLAYER"
            
            PUUID=$(echo "$PLAYER" | jq -r '.puuid')
            GAME_NAME=$(echo "$PLAYER" | jq -r '.gameName')
            TAGLINE=$(echo "$PLAYER" | jq -r '.tagline')
            
            if [ "$PUUID" == "null" ]; then
              echo "‚ö† Player not found or missing PUUID for player_id=$PLAYER_ID"
              continue
            fi
            
            echo "üéÆ Processing ${GAME_NAME}#${TAGLINE}"
            
            # Call proxy endpoints
            echo "  Fetching summoner stats..."
            curl -s "https://summonersheet.de/api/db/stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" || true
            
            echo "  Fetching champion stats..."
            curl -s "https://summonersheet.de/api/db/champion-stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" || true
            
            echo "‚úì Done for ${GAME_NAME}#${TAGLINE}"
          done
