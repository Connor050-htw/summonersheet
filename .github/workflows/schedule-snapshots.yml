name: Daily Snapshot Scheduler

on:
  schedule:
    # Run daily at 04:00 Berlin time (02:00 UTC in summer, 03:00 UTC in winter)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-snapshots:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Active Schedules
        id: fetch
        run: |
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          
          # Fetch ALL active schedules (no date filter yet)
          SCHEDULES=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/scheduled_snapshots?select=id,user_id,player_id,scheduled_until,players(puuid,gameName,tagline)&status=eq.active" \
            -H "apikey: ${{ secrets.VITE_SUPABASE_KEY }}")
          
          echo "Raw response:"
          echo "$SCHEDULES" | jq '.'
          
          # Filter: only schedules where scheduled_until >= now
          NOW=$(date -u +%s)
          FILTERED=$(echo "$SCHEDULES" | jq --arg now "$NOW" '[.[] | select(.scheduled_until | fromdateiso8601 | . >= ($now | tonumber))]')
          
          echo "filtered=$FILTERED" >> $GITHUB_OUTPUT
          echo "Filtered schedules: $FILTERED"

      - name: Process Snapshots
        run: |
          SCHEDULES='${{ steps.fetch.outputs.filtered }}'
          echo "Processing: $SCHEDULES"
          
          if [ "$SCHEDULES" == "[]" ] || [ -z "$SCHEDULES" ]; then
            echo "No active schedules found"
            exit 0
          fi
          
          echo "$SCHEDULES" | jq -r '.[] | @base64' | while read encoded; do
            schedule=$(echo "$encoded" | base64 -d)
            PLAYER_ID=$(echo "$schedule" | jq -r '.player_id')
            PLAYERS=$(echo "$schedule" | jq '.players')
            
            if [ "$PLAYERS" == "null" ]; then
              echo "⚠ Schedule has no player data"
              continue
            fi
            
            PUUID=$(echo "$PLAYERS" | jq -r '.puuid')
            GAME_NAME=$(echo "$PLAYERS" | jq -r '.gameName')
            TAGLINE=$(echo "$PLAYERS" | jq -r '.tagline')
            
            if [ "$PUUID" == "null" ]; then
              echo "⚠ Player missing PUUID"
              continue
            fi
            
            echo "Processing ${GAME_NAME}#${TAGLINE} (Player ${PLAYER_ID})"
            
            # Call proxy endpoints
            curl -s "https://summonersheet.de/api/db/stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" || true
            curl -s "https://summonersheet.de/api/db/champion-stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" || true
            
            echo "✓ Snapshot saved for ${GAME_NAME}#${TAGLINE}"
          done
