name: Daily Snapshot Scheduler

on:
  schedule:
    # Run daily at 04:00 Berlin time (02:00 UTC in summer, 03:00 UTC in winter)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-snapshots:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Active Schedules
        id: fetch
        run: |
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          # Try to use Service Role Key (bypasses RLS), fallback to Anon Key
          API_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.VITE_SUPABASE_KEY }}"
          
          echo "Fetching schedules from: $SUPABASE_URL"
          
          # Fetch ONLY scheduled_snapshots table, no joins, no filters
          SCHEDULES=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/scheduled_snapshots?select=id,user_id,player_id,scheduled_until,status" \
            -H "apikey: ${API_KEY}" \
            -H "Authorization: Bearer ${API_KEY}")
          
          echo "Raw data received: $(echo "$SCHEDULES" | jq 'length') records"
          
          # Filter: only active and not expired (date comparison)
          TODAY=$(date -u +"%Y-%m-%d")
          ACTIVE=$(echo "$SCHEDULES" | jq --arg today "$TODAY" -c '[.[] | select(.status == "active" and .scheduled_until >= $today)]')
          
          echo "‚úÖ Found $(echo "$ACTIVE" | jq 'length') active (not expired) schedules"
          
          # Store as COMPACT single-line JSON
          echo "schedules=${ACTIVE}" >> $GITHUB_OUTPUT

      - name: Process Snapshots
        run: |
          API_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.VITE_SUPABASE_KEY }}"
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          WORKER_URL="${{ secrets.VITE_PROXY_BASE }}"
          SCHEDULES='${{ steps.fetch.outputs.schedules }}'
          
          # Check count
          COUNT=$(echo "$SCHEDULES" | jq 'length')
          echo "üìä Processing $COUNT active schedules"
          
          if [ "$COUNT" -eq 0 ]; then
            echo "‚ÑπÔ∏è No active schedules to process"
            exit 0
          fi
          
          # Process each active schedule
          echo "$SCHEDULES" | jq -c '.[]' | while IFS= read -r schedule; do
            PLAYER_ID=$(echo "$schedule" | jq -r '.player_id')
            
            echo ""
            echo "üîç Processing player_id: $PLAYER_ID"
            
            # Fetch player data including platformId
            PLAYER=$(curl -s -X GET \
              "${SUPABASE_URL}/rest/v1/players?id=eq.${PLAYER_ID}&select=puuid,gameName,tagline,platformId" \
              -H "apikey: ${API_KEY}" \
              -H "Authorization: Bearer ${API_KEY}")
            
            PLAYER_DATA=$(echo "$PLAYER" | jq '.[0]')
            PUUID=$(echo "$PLAYER_DATA" | jq -r '.puuid // empty')
            PLATFORM=$(echo "$PLAYER_DATA" | jq -r '.platformId // empty')
            GAME_NAME=$(echo "$PLAYER_DATA" | jq -r '.gameName // empty')
            TAGLINE=$(echo "$PLAYER_DATA" | jq -r '.tagline // empty')
            
            if [ -z "$PUUID" ]; then
              echo "‚ö†Ô∏è  Skipping: Player $PLAYER_ID has no PUUID"
              continue
            fi
            
            echo "üéÆ Saving snapshot for: ${GAME_NAME}#${TAGLINE} (platform: ${PLATFORM})"
            
            # 1. Fetch summoner data from Riot API via worker
            echo "   Fetching summoner stats..."
            SUMMONER_DATA=$(curl -s "${WORKER_URL}/api/lol/summoner/by-puuid/${PLATFORM}/${PUUID}" || echo '{"error":true}')
            
            if [ "$(echo "$SUMMONER_DATA" | jq -r '.error // false')" = "true" ]; then
              echo "   ‚ùå Error fetching summoner data"
            else
              # Save summoner stats to DB via worker
              STATS_RESULT=$(curl -s -X POST "${WORKER_URL}/api/db/stats/save" \
                -H "Content-Type: application/json" \
                -d "{\"playerId\":${PLAYER_ID},\"summonerData\":${SUMMONER_DATA}}" || echo '{"error":"Stats save failed"}')
              echo "   ‚úÖ Stats: $(echo "$STATS_RESULT" | jq -c '.')"
            fi
            
            # 2. Fetch champion mastery data from Riot API via worker
            echo "   Fetching champion mastery..."
            MASTERY_DATA=$(curl -s "${WORKER_URL}/api/lol/champion-mastery/by-puuid/${PLATFORM}/${PUUID}" || echo '{"error":true}')
            
            if [ "$(echo "$MASTERY_DATA" | jq 'if type == "array" then false else .error // false end')" = "true" ]; then
              echo "   ‚ùå Error fetching champion mastery"
            else
              # Save champion stats to DB via worker
              CHAMP_RESULT=$(curl -s -X POST "${WORKER_URL}/api/db/champion-stats/save" \
                -H "Content-Type: application/json" \
                -d "{\"playerId\":${PLAYER_ID},\"championMasteryData\":${MASTERY_DATA}}" || echo '{"error":"Champions save failed"}')
              echo "   ‚úÖ Champions: $(echo "$CHAMP_RESULT" | jq -c '.')"
            fi
            
            # 3. Fetch rank data from Riot API via worker
            echo "   Fetching rank data..."
            RANK_DATA=$(curl -s "${WORKER_URL}/api/lol/league/by-puuid/${PLATFORM}/${PUUID}" || echo '{"error":true}')
            
            if [ "$(echo "$RANK_DATA" | jq 'if type == "array" then false else .error // false end')" = "true" ]; then
              echo "   ‚ùå Error fetching rank data"
            else
              # Save rank stats to DB via worker
              RANK_RESULT=$(curl -s -X POST "${WORKER_URL}/api/db/rank-stats/save" \
                -H "Content-Type: application/json" \
                -d "{\"playerId\":${PLAYER_ID},\"rankData\":${RANK_DATA}}" || echo '{"error":"Rank save failed"}')
              echo "   ‚úÖ Rank: $(echo "$RANK_RESULT" | jq -c '.')"
            fi
            
            echo "‚úÖ Snapshot complete for ${GAME_NAME}#${TAGLINE}"
          done
          
          echo ""
          echo "üéâ All done!"
