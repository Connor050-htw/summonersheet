name: Daily Snapshot Scheduler

on:
  schedule:
    # Run daily at 04:00 Berlin time (02:00 UTC in summer, 03:00 UTC in winter)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-snapshots:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Active Schedules
        id: fetch
        run: |
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          # Try to use Service Role Key (bypasses RLS), fallback to Anon Key
          API_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.VITE_SUPABASE_KEY }}"
          
          echo "Fetching schedules from: $SUPABASE_URL"
          echo "Using API Key: ${API_KEY:0:20}..."
          
          # Fetch ONLY scheduled_snapshots table, no joins, no filters
          SCHEDULES=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/scheduled_snapshots?select=id,user_id,player_id,scheduled_until,status" \
            -H "apikey: ${API_KEY}" \
            -H "Authorization: Bearer ${API_KEY}")
          
          echo "Full API Response:"
          echo "$SCHEDULES" | jq '.' 2>/dev/null || echo "$SCHEDULES"
          
          # Store in output
          echo "schedules=$SCHEDULES" >> $GITHUB_OUTPUT

      - name: Process Snapshots
        run: |
          API_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.VITE_SUPABASE_KEY }}"
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          SCHEDULES='${{ steps.fetch.outputs.schedules }}'
          
          echo "Input schedules: $SCHEDULES"
          
          # Check if empty or error
          if echo "$SCHEDULES" | grep -q "error" || echo "$SCHEDULES" | grep -q "^null"; then
            echo "API Error: $SCHEDULES"
            exit 1
          fi
          
          # Check count
          COUNT=$(echo "$SCHEDULES" | jq 'length' 2>/dev/null || echo 0)
          echo "Found $COUNT schedules"
          
          if [ "$COUNT" -eq 0 ]; then
            echo "No schedules to process"
            exit 0
          fi
          
          # Filter: only active and not expired
          NOW=$(date -u +%s)
          ACTIVE=$(echo "$SCHEDULES" | jq --argjson now "$NOW" '[.[] | select(.status == "active" and (.scheduled_until | fromdateiso8601 | . >= ($now | tonumber)))]')
          
          ACTIVE_COUNT=$(echo "$ACTIVE" | jq 'length')
          echo "Active schedules (not expired): $ACTIVE_COUNT"
          
          if [ "$ACTIVE_COUNT" -eq 0 ]; then
            echo "No active schedules to process"
            exit 0
          fi
          
          # Process each active schedule
          echo "$ACTIVE" | jq -c '.[]' | while IFS= read -r schedule; do
            PLAYER_ID=$(echo "$schedule" | jq -r '.player_id')
            
            echo "Processing player_id: $PLAYER_ID"
            
            # Fetch player data
            PLAYER=$(curl -s -X GET \
              "${SUPABASE_URL}/rest/v1/players?player_id=eq.${PLAYER_ID}&select=puuid,gameName,tagline" \
              -H "apikey: ${API_KEY}")
            
            PLAYER_DATA=$(echo "$PLAYER" | jq '.[0]')
            PUUID=$(echo "$PLAYER_DATA" | jq -r '.puuid // empty')
            GAME_NAME=$(echo "$PLAYER_DATA" | jq -r '.gameName // empty')
            TAGLINE=$(echo "$PLAYER_DATA" | jq -r '.tagline // empty')
            
            if [ -z "$PUUID" ]; then
              echo "âš  Skipping: Player $PLAYER_ID has no PUUID"
              continue
            fi
            
            echo "ðŸŽ® Saving snapshot for: ${GAME_NAME}#${TAGLINE}"
            
            # Call proxy endpoints
            curl -s "https://summonersheet.de/api/db/stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" > /dev/null 2>&1
            curl -s "https://summonersheet.de/api/db/champion-stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" > /dev/null 2>&1
            
            echo "âœ“ Snapshot saved"
          done
