name: Daily Snapshot Scheduler

on:
  schedule:
    # Run daily at 04:00 Berlin time (02:00 UTC in summer, 03:00 UTC in winter)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-snapshots:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Process Snapshots
        run: |
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          API_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          
          # Validate credentials
          if [ -z "$API_KEY" ]; then
            echo "âŒ ERROR: SUPABASE_SERVICE_ROLE_KEY is not set!"
            echo "Add it to GitHub Secrets: https://github.com/YOUR_REPO/settings/secrets/actions"
            exit 1
          fi
          
          if [ -z "$SUPABASE_URL" ]; then
            echo "âŒ ERROR: VITE_SUPABASE_URL is not set!"
            exit 1
          fi
          
          echo "âœ… Using Service Role Key"
          echo "ðŸ“‹ Fetching active schedules from: $SUPABASE_URL"
          
          # Fetch ALL schedules (we'll filter in bash)
          RESPONSE=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/scheduled_snapshots?select=id,player_id,scheduled_until,status" \
            -H "apikey: ${API_KEY}" \
            -w "\n%{http_code}")
          
          # Split response and status code
          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)
          
          echo "HTTP Status: $STATUS"
          
          if [ "$STATUS" != "200" ]; then
            echo "âŒ API Error: $BODY"
            exit 1
          fi
          
          echo "Raw response: $BODY"
          
          # Validate JSON
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "âŒ Invalid JSON response"
            exit 1
          fi
          
          COUNT=$(echo "$BODY" | jq 'length')
          echo "Found $COUNT total schedules"
          
          if [ "$COUNT" -eq 0 ]; then
            echo "âœ“ No schedules found (nothing to do)"
            exit 0
          fi
          
          # Filter: only active and not expired
          NOW=$(date -u +%s)
          ACTIVE=$(echo "$BODY" | jq -r --argjson now "$NOW" '.[] | select(.status == "active" and (.scheduled_until | fromdateiso8601 | . >= ($now | tonumber))) | @json')
          
          ACTIVE_COUNT=$(echo "$ACTIVE" | grep -c . || echo 0)
          echo "Found $ACTIVE_COUNT active (non-expired) schedules"
          
          if [ "$ACTIVE_COUNT" -eq 0 ]; then
            echo "âœ“ No active schedules to process"
            exit 0
          fi
          
          # Process each active schedule
          echo "$ACTIVE" | while read -r schedule_json; do
            # Parse JSON
            schedule=$(echo "$schedule_json" | jq 'fromjson')
            PLAYER_ID=$(echo "$schedule" | jq -r '.player_id')
            
            echo ""
            echo "ðŸ”„ Processing player_id: $PLAYER_ID"
            
            # Fetch player
            PLAYER_RESPONSE=$(curl -s -X GET \
              "${SUPABASE_URL}/rest/v1/players?player_id=eq.${PLAYER_ID}" \
              -H "apikey: ${API_KEY}")
            
            PLAYER=$(echo "$PLAYER_RESPONSE" | jq '.[0]')
            PUUID=$(echo "$PLAYER" | jq -r '.puuid // empty')
            GAME_NAME=$(echo "$PLAYER" | jq -r '.gameName // "?"')
            TAGLINE=$(echo "$PLAYER" | jq -r '.tagline // "?"')
            
            if [ -z "$PUUID" ]; then
              echo "  âš  Skipping: No PUUID"
              continue
            fi
            
            echo "  ðŸŽ® ${GAME_NAME}#${TAGLINE}"
            
            # Save stats
            echo "    Saving summoner stats..."
            curl -s "https://summonersheet.de/api/db/stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" > /dev/null 2>&1
            
            echo "    Saving champion stats..."
            curl -s "https://summonersheet.de/api/db/champion-stats/save?puuid=${PUUID}&player_id=${PLAYER_ID}" > /dev/null 2>&1
            
            echo "  âœ… Done"
          done
          
          echo ""
          echo "âœ… Snapshot job completed"
